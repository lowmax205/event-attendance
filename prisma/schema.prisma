generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model SecurityLog {
  id        String   @id @default(cuid())
  userId    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  action    String
  metadata  Json?
  User      User?    @relation(fields: [userId], references: [id])

  @@index([action, createdAt])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([refreshToken])
  @@index([userId])
}

model User {
  id                  String         @id @default(cuid())
  email               String         @unique
  passwordHash        String
  role                Role           @default(Student)
  accountStatus       String         @default("active")
  emailVerified       Boolean        @default(false)
  createdAt           DateTime       @default(now())
  lastLoginAt         DateTime?
  firstName           String
  lastName            String
  attendances         Attendance[]
  verifiedAttendances Attendance[]   @relation("AttendanceVerifier")
  createdEvents       Event[]        @relation("EventCreator")
  SecurityLog         SecurityLog[]
  Session             Session[]
  systemConfigUpdates SystemConfig[] @relation("SystemConfigUpdater")
  UserProfile         UserProfile?

  @@index([email])
}

model UserProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  section           String?
  department        String
  updatedAt         DateTime @updatedAt
  contactNumber     String?
  createdAt         DateTime @default(now())
  studentId         String   @unique
  yearLevel         Int
  documentUrls      String[] @default([])
  profilePictureUrl String?
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Event {
  id                 String       @id @default(cuid())
  name               String
  description        String?
  startDateTime      DateTime
  endDateTime        DateTime
  venueLatitude      Float
  venueLongitude     Float
  venueName          String
  venueAddress       String?
  checkInBufferMins  Int          @default(30)
  checkOutBufferMins Int          @default(30)
  qrCodeUrl          String?
  qrCodePayload      String       @unique
  status             EventStatus  @default(Active)
  createdById        String
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  attendances        Attendance[]
  createdBy          User         @relation("EventCreator", fields: [createdById], references: [id])

  @@index([startDateTime, endDateTime])
  @@index([status])
  @@index([createdById])
}

model Attendance {
  id                  String             @id @default(cuid())
  eventId             String
  userId              String
  verificationStatus  VerificationStatus @default(Pending)
  verifiedById        String?
  verifiedAt          DateTime?
  disputeNote         String?
  checkInBackPhoto    String?
  checkInDistance     Float?
  checkInFrontPhoto   String?
  checkInIpAddress    String?
  checkInLatitude     Float?
  checkInLongitude    Float?
  checkInSignature    String?
  checkInSubmittedAt  DateTime?
  checkInUserAgent    String?
  checkOutBackPhoto   String?
  checkOutDistance    Float?
  checkOutFrontPhoto  String?
  checkOutIpAddress   String?
  checkOutLatitude    Float?
  checkOutLongitude   Float?
  checkOutSignature   String?
  checkOutSubmittedAt DateTime?
  checkOutUserAgent   String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @default(now()) @updatedAt
  event               Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  verifiedBy          User?              @relation("AttendanceVerifier", fields: [verifiedById], references: [id])

  @@unique([eventId, userId])
  @@index([userId, checkInSubmittedAt])
  @@index([eventId, verificationStatus])
  @@index([verificationStatus])
}

model SystemConfig {
  id                        String   @id @default(cuid())
  defaultGpsRadiusMeters    Int      @default(100)
  defaultCheckInBufferMins  Int      @default(30)
  defaultCheckOutBufferMins Int      @default(30)
  updatedAt                 DateTime @updatedAt
  updatedById               String
  updatedBy                 User     @relation("SystemConfigUpdater", fields: [updatedById], references: [id])
}

enum Role {
  Student
  Moderator
  Administrator
}

enum EventStatus {
  Active
  Completed
  Cancelled
}

enum VerificationStatus {
  Pending
  Approved
  Rejected
  Disputed
}
